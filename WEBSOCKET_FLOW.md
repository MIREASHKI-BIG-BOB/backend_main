# WebSocket Data Flow

## Архитектура WebSocket соединений

### 1️⃣ Датчики → Backend (ws://localhost:8080/ws/sensor)

**Клиенты:** Физические датчики CTG
**Аутентификация:** UUID + Token в заголовке `X-Auth-Sensor-Token`

```
Датчик → /ws/sensor?sensor_id=UUID
   ↓
Handler проверяет токен
   ↓
Создает/проверяет обследование в БД
   ↓
Принимает CTG данные:
{
  "sensorID": "uuid",
  "secFromStart": 12.5,
  "data": {
    "BPMChild": 140.5,  // Сердцебиение плода
    "uterus": 15.2,     // Тонус матки
    "spasms": 0.0       // Схватки
  }
}
   ↓
Параллельно:
  → Сохранение в БД (таблица ctg)
  → Отправка в ML сервис
```

### 2️⃣ Backend → ML Service (ws://localhost:8081/ws/ctg)

**Клиент:** Backend (auto-reconnect)
**Назначение:** Анализ CTG данных ML моделью

```
Backend → ML Service
   ↓
Отправка CTG данных для анализа
   ↓
ML Service анализирует данные
   ↓
ML Service возвращает результат анализа
```

### 3️⃣ ML Service → Backend → Frontend (ws://localhost:8080/ws)

**Клиенты:** Web приложение (фронтенд)
**Назначение:** Получение результатов ML анализа в реальном времени

```
ML Service отправляет результат
   ↓
Backend.listenMLService() получает данные
   ↓
frontendHandler.BroadcastToFrontend()
   ↓
Broadcast всем подключенным фронтенд клиентам
   ↓
Фронтенд получает данные в реальном времени
```

## Полный поток данных

```
┌──────────┐
│  Датчик  │ ──CTG──> /ws/sensor
└──────────┘            │
                        ↓
                   ┌─────────┐
                   │ Backend │
                   │ Handler │
                   └─────────┘
                        │
            ┌───────────┴───────────┐
            ↓                       ↓
      ┌─────────┐            ┌──────────┐
      │   БД    │            │ ML Srv   │
      │ SQLite  │            │ ws:8081  │
      └─────────┘            └──────────┘
                                  │
                                  ↓
                          ML анализирует
                                  │
                                  ↓
                         ┌─────────────┐
                         │   Backend   │
                         │ listenML()  │
                         └─────────────┘
                                  │
                                  ↓
                         ┌─────────────┐
                         │  Frontend   │
                         │   ws:/ws    │
                         └─────────────┘
```

## Endpoints

### WebSocket Endpoints

| Endpoint                        | Клиент       | Описание                        |
| ------------------------------- | ------------ | ------------------------------- |
| `ws://localhost:8080/ws/sensor` | Датчики CTG  | Прием данных от датчиков        |
| `ws://localhost:8080/ws`        | Web Frontend | Отправка результатов ML анализа |
| `ws://localhost:8081/ws/ctg`    | Backend      | ML сервис для анализа           |

### HTTP Endpoints

| Endpoint             | Метод | Описание                   |
| -------------------- | ----- | -------------------------- |
| `/api/health`        | GET   | Health check               |
| `/api/sensors/start` | GET   | Запустить следующий датчик |
| `/api/sensors/stop`  | GET   | Остановить все датчики     |

## Особенности реализации

### 1. Auto-reconnect к ML сервису

- Автоматическое переподключение при обрыве связи
- Retry каждые 5 секунд при ошибке
- Thread-safe через mutex

### 2. Управление обследованиями

- Автоматическое создание нового обследования при подключении
- Закрытие обследования при отключении последнего датчика
- Все CTG данные привязаны к обследованию

### 3. Broadcast для фронтенда

- Buffered channel (256) для очереди сообщений
- Автоматическое удаление отключенных клиентов
- Thread-safe операции с клиентами

### 4. Graceful error handling

- Логирование всех ошибок
- Продолжение работы при временных сбоях
- Очистка ресурсов при отключении
